<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>scenographer.sample API documentation</title>
    <meta name="description" content="TableSample" />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>

  <style type="text/css">
  .codehilite .hll { background-color: #ffffcc }
.codehilite  { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #0000FF } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>

  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#scenographer.sample.increase_csv_limit">increase_csv_limit</a></li>
    <li class="mono"><a href="#scenographer.sample.select">select</a></li>
    <li class="mono"><a href="#scenographer.sample.text">text</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#scenographer.sample.TableSample">TableSample</a></span>
        
          
  <ul>
    <li class="mono"><a href="#scenographer.sample.TableSample.follow_conditions">follow_conditions</a></li>
    <li class="mono"><a href="#scenographer.sample.TableSample.persist_keys">persist_keys</a></li>
    <li class="mono"><a href="#scenographer.sample.TableSample.persist_records">persist_records</a></li>
    <li class="mono"><a href="#scenographer.sample.TableSample.sample">sample</a></li>
    <li class="mono"><a href="#scenographer.sample.TableSample.sample_dag">sample_dag</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">scenographer.sample</span> module</h1>
  <p>TableSample</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-scenographer.sample', this);">Show source &equiv;</a></p>
  <div id="source-scenographer.sample" class="source">
    <div class="codehilite"><pre><span></span><span class="s2">&quot;TableSample&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">csv</span> <span class="kn">import</span> <span class="n">DictReader</span><span class="p">,</span> <span class="n">field_size_limit</span>

<span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">pyrsistent</span> <span class="kn">import</span> <span class="n">freeze</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">text</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="kn">import</span> <span class="n">Select</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">postgresql</span>

<span class="kn">from</span> <span class="nn">scenographer.database</span> <span class="kn">import</span> <span class="n">Database</span>
<span class="kn">from</span> <span class="nn">scenographer.relations</span> <span class="kn">import</span> <span class="n">RelationDAG</span>


<span class="k">class</span> <span class="nc">TableSample</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TableSample is a wrapper around the operations</span>
<span class="sd">    to sample a single table</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key_database</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">&quot;sqlite://&quot;</span><span class="p">)</span>

    <span class="n">table</span><span class="p">:</span> <span class="n">Table</span>
    <span class="n">conditions</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">sample_dag</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">source_database</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span>
        <span class="n">relations</span><span class="p">:</span> <span class="n">RelationDAG</span><span class="p">,</span>
        <span class="n">query_modifiers</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;TableSample&quot;</span><span class="p">]:</span>
        <span class="s2">&quot;Samples a database according to its relation graph&quot;</span>

        <span class="c1"># Change current working dir to our output directory</span>
        <span class="c1"># This way we avoid TableSample instances containing that information</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="c1"># Prepare the sqlite db</span>
        <span class="n">relations</span><span class="o">.</span><span class="n">key_schema</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
        <span class="n">relations</span><span class="o">.</span><span class="n">key_schema</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">relations</span><span class="o">.</span><span class="n">topologically_sorted</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="n">table</span><span class="p">,</span>
                <span class="n">conditions</span><span class="o">=</span><span class="n">freeze</span><span class="p">(</span><span class="n">query_modifiers</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s2">&quot;conditions&quot;</span><span class="p">]),</span>
                <span class="n">limit</span><span class="o">=</span><span class="n">query_modifiers</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s2">&quot;limit&quot;</span><span class="p">],</span>
            <span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">source_database</span><span class="p">)</span>

            <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">samples</span>

    <span class="c1"># @classmethod</span>
    <span class="c1"># @lru_cache()</span>
    <span class="c1"># def key_database(cls, relations) -&gt; Database:</span>
    <span class="c1">#     return Database(&quot;sqlite://&quot;)</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">key_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the table with the associated metadata</span>
<span class="sd">        tied to the key database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">tables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">source_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the table with the associated metadata</span>
<span class="sd">        tied to the source database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">key_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Column</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property defining the columns of the key database:</span>
<span class="sd">        the primary_keys and foreign_keys of each table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_table</span><span class="o">.</span><span class="n">columns</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">foreign_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Column</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the foreign keys of the table by listing</span>
<span class="sd">        the key columns and excluding any primary_key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">is_entrypoint</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property defining if the table has foreign_keys.</span>
<span class="sd">        If it is false it means it has no dependencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Select</span><span class="p">:</span>
        <span class="s2">&quot;SQLAlchemy query object for the sampling query&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">condition</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_entrypoint</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">follow_conditions</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">follow_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Select</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Select</span><span class="p">:</span>
        <span class="s2">&quot;Append WHERE clauses to restrict the rows depending on the data already extracted&quot;</span>
        <span class="n">foreign_key</span><span class="p">:</span> <span class="n">Column</span>
        <span class="n">primary_key</span><span class="p">:</span> <span class="n">Column</span>

        <span class="c1"># For each foreign_key, build a where clause in the form of:</span>
        <span class="c1">#   WHERE sometable_id in (&lt;select id from sometable&gt;)</span>
        <span class="c1"># The subquery is executed on the key database and its results are</span>
        <span class="c1"># parametrized into the final query.</span>
        <span class="k">for</span> <span class="n">foreign_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>

            <span class="n">primary_key</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">)</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span><span class="o">.</span><span class="n">column</span>
            <span class="n">pk_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">execute_return_list</span><span class="p">(</span>
                <span class="n">select</span><span class="p">([</span><span class="n">primary_key</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">source_fk</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_table</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">foreign_key</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pk_data</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">source_fk</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">pk_data</span><span class="p">)</span> <span class="o">|</span> <span class="n">source_fk</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">source_fk</span><span class="o">.</span><span class="n">nullslast</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">source_fk</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">query</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s2">&quot;Raw SQL representation of the sampling query&quot;</span>
        <span class="n">complete_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">dialect</span><span class="o">=</span><span class="n">postgresql</span><span class="o">.</span><span class="n">dialect</span><span class="p">(),</span> <span class="n">compile_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;literal_binds&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

        <span class="c1"># Sampling requires we always extract all the columns, but</span>
        <span class="c1"># complete_query comes with the entire columns list.</span>
        <span class="c1"># So let&#39;s replace the column list with a wildcard:</span>
        <span class="n">query_str</span> <span class="o">=</span> <span class="s2">&quot;SELECT * &quot;</span> <span class="o">+</span> <span class="n">complete_query</span><span class="p">[</span><span class="n">complete_query</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;FROM&quot;</span><span class="p">)</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">query_str</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">persisted_records_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The path for the csv file for the data to be written in</span>
<span class="sd">        Relative to classmethod `sample_dag` directory argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">persist_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Insert retrieved keys from the table csv file into the sqlite key database.&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">persisted_records_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">persisted_record</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_columns</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">persisted_record</span> <span class="ow">in</span> <span class="n">DictReader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Got </span><span class="si">{}</span><span class="s2"> records for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span> <span class="n">keys</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">persist_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_database</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Insert retrieved rows into persisted_records_path&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Querying </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">persisted_records_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;a+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
            <span class="n">source_database</span><span class="o">.</span><span class="n">copy_to_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_database</span><span class="p">):</span>
        <span class="s2">&quot;Samples the table&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persist_records</span><span class="p">(</span><span class="n">source_database</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persist_keys</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span>


<span class="k">def</span> <span class="nf">increase_csv_limit</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is needed, due to default limits.</span>
<span class="sd">    Taken from https://stackoverflow.com/a/15063941</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_int</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># decrease the max_int value by factor 10</span>
        <span class="c1"># as long as the OverflowError occurs.</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">field_size_limit</span><span class="p">(</span><span class="n">max_int</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="ne">OverflowError</span><span class="p">:</span>
            <span class="n">max_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_int</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>


<span class="n">increase_csv_limit</span><span class="p">()</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="scenographer.sample.increase_csv_limit">
    <p>def <span class="ident">increase_csv_limit</span>(</p><p>)</p>
    </div>
    

    
  
    <div class="desc"><p>This is needed, due to default limits.
Taken from https://stackoverflow.com/a/15063941</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-scenographer.sample.increase_csv_limit', this);">Show source &equiv;</a></p>
  <div id="source-scenographer.sample.increase_csv_limit" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">increase_csv_limit</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is needed, due to default limits.</span>
<span class="sd">    Taken from https://stackoverflow.com/a/15063941</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_int</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># decrease the max_int value by factor 10</span>
        <span class="c1"># as long as the OverflowError occurs.</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">field_size_limit</span><span class="p">(</span><span class="n">max_int</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="ne">OverflowError</span><span class="p">:</span>
            <span class="n">max_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_int</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="scenographer.sample.select">
    <p>def <span class="ident">select</span>(</p><p>columns=None, whereclause=None, from_obj=None, distinct=False, having=None, correlate=True, prefixes=None, suffixes=None, **kwargs)</p>
    </div>
    

    
  
    <div class="desc"><p>Construct a new :class:<code>.Select</code>.</p>
<p>Similar functionality is also available via the
:meth:<code>.FromClause.select</code> method on any :class:<code>.FromClause</code>.</p>
<p>All arguments which accept :class:<code>.ClauseElement</code> arguments also
accept string arguments, which will be converted as appropriate into
either :func:<code>text()</code> or :func:<code>literal_column()</code> constructs.</p>
<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="p">:</span><span class="n">ref</span><span class="p">:</span><span class="ss">`coretutorial_selecting`</span> <span class="o">-</span> <span class="n">Core</span> <span class="n">Tutorial</span> <span class="n">description</span> <span class="n">of</span>
<span class="p">:</span><span class="n">func</span><span class="p">:</span><span class="ss">`.select`</span><span class="p">.</span>
</pre></div>


<p>:param columns:
  A list of :class:<code>.ColumnElement</code> or :class:<code>.FromClause</code>
  objects which will form the columns clause of the resulting
  statement.   For those objects that are instances of
  :class:<code>.FromClause</code> (typically :class:<code>.Table</code> or :class:<code>.Alias</code>
  objects), the :attr:<code>.FromClause.c</code> collection is extracted
  to form a collection of :class:<code>.ColumnElement</code> objects.</p>
<p>This parameter will also accept :class:<code>.Text</code> constructs as
  given, as well as ORM-mapped classes.</p>
<p>.. note::</p>
<div class="codehilite"><pre><span></span><span class="n">The</span> <span class="o">:</span><span class="n">paramref</span><span class="o">:</span><span class="err">`</span><span class="o">.</span><span class="na">select</span><span class="o">.</span><span class="na">columns</span><span class="err">`</span> <span class="n">parameter</span> <span class="k">is</span> <span class="n">not</span> <span class="n">available</span>
<span class="k">in</span> <span class="n">the</span> <span class="n">method</span> <span class="n">form</span> <span class="n">of</span> <span class="o">:</span><span class="n">func</span><span class="o">:</span><span class="err">`</span><span class="o">.</span><span class="na">select</span><span class="err">`</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">g</span><span class="o">.</span>
<span class="o">:</span><span class="n">meth</span><span class="o">:</span><span class="err">`</span><span class="o">.</span><span class="na">FromClause</span><span class="o">.</span><span class="na">select</span><span class="err">`</span><span class="o">.</span>
</pre></div>


<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="p">:</span><span class="n">meth</span><span class="p">:</span><span class="o">`</span><span class="p">.</span><span class="k">Select</span><span class="p">.</span><span class="k">column</span><span class="o">`</span>

<span class="p">:</span><span class="n">meth</span><span class="p">:</span><span class="o">`</span><span class="p">.</span><span class="k">Select</span><span class="p">.</span><span class="n">with_only_columns</span><span class="o">`</span>
</pre></div>


<p>:param whereclause:
  A :class:<code>.ClauseElement</code> expression which will be used to form the
  <code>WHERE</code> clause.   It is typically preferable to add WHERE
  criterion to an existing :class:<code>.Select</code> using method chaining
  with :meth:<code>.Select.where</code>.</p>
<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="err">:meth:`.Select.where`</span>
</pre></div>


<p>:param from_obj:
  A list of :class:<code>.ClauseElement</code> objects which will be added to the
  <code>FROM</code> clause of the resulting statement.  This is equivalent
  to calling :meth:<code>.Select.select_from</code> using method chaining on
  an existing :class:<code>.Select</code> object.</p>
<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="err">:meth:`.Select.select_from` - full description of explicit</span>
<span class="err">FROM clause specification.</span>
</pre></div>


<p>:param autocommit: legacy autocommit parameter.</p>
<p>.. deprecated:: 0.6 The :paramref:<code>.select.autocommit</code> parameter is deprecated and will be removed in a future release.  Please refer to the :paramref:<code>.Connection.execution_options.autocommit</code> parameter in conjunction with the the :meth:<code>.Executable.execution_options</code> method in order to affect the autocommit behavior for a statement.</p>
<p>:param bind=None:
  an :class:<code>~.Engine</code> or :class:<code>~.Connection</code> instance
  to which the
  resulting :class:<code>.Select</code> object will be bound.  The
  :class:<code>.Select</code> object will otherwise automatically bind to
  whatever :class:<code>~.base.Connectable</code> instances can be located within
  its contained :class:<code>.ClauseElement</code> members.</p>
<p>:param correlate=True:
  indicates that this :class:<code>.Select</code> object should have its
  contained :class:<code>.FromClause</code> elements "correlated" to an enclosing
  :class:<code>.Select</code> object.  It is typically preferable to specify
  correlations on an existing :class:<code>.Select</code> construct using
  :meth:<code>.Select.correlate</code>.</p>
<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="err">:meth:`.Select.correlate` - full description of correlation.</span>
</pre></div>


<p>:param distinct=False:
  when <code>True</code>, applies a <code>DISTINCT</code> qualifier to the columns
  clause of the resulting statement.</p>
<p>The boolean argument may also be a column expression or list
  of column expressions - this is a special calling form which
  is understood by the PostgreSQL dialect to render the
  <code>DISTINCT ON (&lt;columns&gt;)</code> syntax.</p>
<p><code>distinct</code> is also available on an existing :class:<code>.Select</code>
  object via the :meth:<code>~.Select.distinct</code> method.</p>
<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="err">:meth:`.Select.distinct`</span>
</pre></div>


<p>:param for_update=False:
  when <code>True</code>, applies <code>FOR UPDATE</code> to the end of the
  resulting statement.</p>
<p><code>for_update</code> accepts various string values interpreted by
  specific backends, including:</p>
<ul>
<li><code>"read"</code> - on MySQL, translates to <code>LOCK IN SHARE MODE</code>;
    on PostgreSQL, translates to <code>FOR SHARE</code>.</li>
<li><code>"nowait"</code> - on PostgreSQL and Oracle, translates to
    <code>FOR UPDATE NOWAIT</code>.</li>
<li><code>"read_nowait"</code> - on PostgreSQL, translates to
    <code>FOR SHARE NOWAIT</code>.</li>
</ul>
<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="err">:meth:`.Select.with_for_update` - improved API for</span>
<span class="err">specifying the ``FOR UPDATE`` clause.</span>
</pre></div>


<p>:param group_by:
  a list of :class:<code>.ClauseElement</code> objects which will comprise the
  <code>GROUP BY</code> clause of the resulting select.  This parameter
  is typically specified more naturally using the
  :meth:<code>.Select.group_by</code> method on an existing :class:<code>.Select</code>.</p>
<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="err">:meth:`.Select.group_by`</span>
</pre></div>


<p>:param having:
  a :class:<code>.ClauseElement</code> that will comprise the <code>HAVING</code> clause
  of the resulting select when <code>GROUP BY</code> is used.  This parameter
  is typically specified more naturally using the
  :meth:<code>.Select.having</code> method on an existing :class:<code>.Select</code>.</p>
<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="err">:meth:`.Select.having`</span>
</pre></div>


<p>:param limit=None:
  a numerical value which usually renders as a <code>LIMIT</code>
  expression in the resulting select.  Backends that don't
  support <code>LIMIT</code> will attempt to provide similar
  functionality.    This parameter is typically specified more
  naturally using the :meth:<code>.Select.limit</code> method on an existing
  :class:<code>.Select</code>.</p>
<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="err">:meth:`.Select.limit`</span>
</pre></div>


<p>:param offset=None:
  a numeric value which usually renders as an <code>OFFSET</code>
  expression in the resulting select.  Backends that don't
  support <code>OFFSET</code> will attempt to provide similar
  functionality.  This parameter is typically specified more naturally
  using the :meth:<code>.Select.offset</code> method on an existing
  :class:<code>.Select</code>.</p>
<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="err">:meth:`.Select.offset`</span>
</pre></div>


<p>:param order_by:
  a scalar or list of :class:<code>.ClauseElement</code> objects which will
  comprise the <code>ORDER BY</code> clause of the resulting select.
  This parameter is typically specified more naturally using the
  :meth:<code>.Select.order_by</code> method on an existing :class:<code>.Select</code>.</p>
<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="err">:meth:`.Select.order_by`</span>
</pre></div>


<p>:param use_labels=False:
  when <code>True</code>, the statement will be generated using labels
  for each column in the columns clause, which qualify each
  column with its parent table's (or aliases) name so that name
  conflicts between columns in different tables don't occur.
  The format of the label is <tablename>_<column>.  The "c"
  collection of the resulting :class:<code>.Select</code> object will use these
  names as well for targeting column members.</p>
<p>This parameter can also be specified on an existing
  :class:<code>.Select</code> object using the :meth:<code>.Select.apply_labels</code>
  method.</p>
<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="err">:meth:`.Select.apply_labels`</span>
</pre></div></div>
  <div class="source_cont">
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="scenographer.sample.text">
    <p>def <span class="ident">text</span>(</p><p>text, bind=None, bindparams=None, typemap=None, autocommit=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Construct a new :class:<code>.TextClause</code> clause, representing
a textual SQL string directly.</p>
<p>E.g.::</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">text</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users&quot;</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>


<p>The advantages :func:<code>.text</code> provides over a plain string are
backend-neutral support for bind parameters, per-statement
execution options, as well as
bind parameter and result-column typing behavior, allowing
SQLAlchemy type constructs to play a role when executing
a statement that is specified literally.  The construct can also
be provided with a <code>.c</code> collection of column elements, allowing
it to be embedded in other SQL expression constructs as a subquery.</p>
<p>Bind parameters are specified by name, using the format <code>:name</code>.
E.g.::</p>
<div class="codehilite"><pre><span></span><span class="err">t = text(&quot;SELECT * FROM users WHERE id=:user_id&quot;)</span>
<span class="err">result = connection.execute(t, user_id=12)</span>
</pre></div>


<p>For SQL statements where a colon is required verbatim, as within
an inline string, use a backslash to escape::</p>
<div class="codehilite"><pre><span></span><span class="err">t = text(&quot;SELECT * FROM users WHERE name=&#39;\:username&#39;&quot;)</span>
</pre></div>


<p>The :class:<code>.TextClause</code> construct includes methods which can
provide information about the bound parameters as well as the column
values which would be returned from the textual statement, assuming
it's an executable SELECT type of statement.  The
:meth:<code>.TextClause.bindparams</code> method is used to provide bound
parameter detail, and :meth:<code>.TextClause.columns</code> method allows
specification of return columns including names and types::</p>
<div class="codehilite"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="nb">text</span><span class="p">(</span><span class="ss">&quot;SELECT * FROM users WHERE id=:user_id&quot;</span><span class="p">).</span><span class="err">\</span>
        <span class="n">bindparams</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">7</span><span class="p">).</span><span class="err">\</span>
        <span class="n">columns</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="nb">Integer</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">String</span><span class="p">)</span>

<span class="k">for</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">in</span> <span class="k">connection</span><span class="p">.</span><span class="k">execute</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="n">print</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</pre></div>


<p>The :func:<code>.text</code> construct is used in cases when
a literal string SQL fragment is specified as part of a larger query,
such as for the WHERE clause of a SELECT statement::</p>
<div class="codehilite"><pre><span></span><span class="err">s = select([users.c.id, users.c.name]).where(text(&quot;id=:user_id&quot;))</span>
<span class="err">result = connection.execute(s, user_id=12)</span>
</pre></div>


<p>:func:<code>.text</code> is also used for the construction
of a full, standalone statement using plain text.
As such, SQLAlchemy refers
to it as an :class:<code>.Executable</code> object, and it supports
the :meth:<code>Executable.execution_options</code> method.  For example,
a :func:<code>.text</code> construct that should be subject to "autocommit"
can be set explicitly so using the
:paramref:<code>.Connection.execution_options.autocommit</code> option::</p>
<div class="codehilite"><pre><span></span><span class="err">t = text(&quot;EXEC my_procedural_thing()&quot;).\</span>
<span class="err">        execution_options(autocommit=True)</span>
</pre></div>


<p>Note that SQLAlchemy's usual "autocommit" behavior applies to
:func:<code>.text</code> constructs implicitly - that is, statements which begin
with a phrase such as <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>,
or a variety of other phrases specific to certain backends, will
be eligible for autocommit if no transaction is in progress.</p>
<p>:param text:
  the text of the SQL statement to be created.  use <code>:&lt;param&gt;</code>
  to specify bind parameters; they will be compiled to their
  engine-specific format.</p>
<p>.. warning:: The :paramref:<code>.text.text</code> argument to :func:<code>.text</code> can be passed as a Python string argument, which will be treated as <strong>trusted SQL text</strong> and rendered as given.  <strong>DO NOT PASS UNTRUSTED INPUT TO THIS PARAMETER</strong>.</p>
<p>:param autocommit: whether or not to set the "autocommit" execution
  option for this :class:<code>.TextClause</code> object.</p>
<p>.. deprecated:: 0.6 The :paramref:<code>.text.autocommit</code> parameter is deprecated and will be removed in a future release.  Please use the :paramref:<code>.Connection.execution_options.autocommit</code> parameter in conjunction with the :meth:<code>.Executable.execution_options</code> method.</p>
<p>:param bind:
  an optional connection or engine to be used for this text query.</p>
<p>:param bindparams:
  A list of :func:<code>.bindparam</code> instances used to
  provide information about parameters embedded in the statement.</p>
<p>.. deprecated:: 0.9 The :paramref:<code>.text.bindparams</code> parameter is deprecated and will be removed in a future release.  Please refer to the :meth:<code>.TextClause.bindparams</code> method.</p>
<p>E.g.::</p>
<div class="codehilite"><pre><span></span><span class="err">  stmt = text(&quot;SELECT * FROM table WHERE id=:id&quot;,</span>
<span class="err">            bindparams=[bindparam(&#39;id&#39;, value=5, type_=Integer)])</span>
</pre></div>


<p>:param typemap:
  A dictionary mapping the names of columns represented in the columns
  clause of a <code>SELECT</code> statement to type objects.</p>
<p>.. deprecated:: 0.9 The :paramref:<code>.text.typemap</code> parameter is deprecated and will be removed in a future release.  Please refer to the :meth:<code>.TextClause.columns</code> method.</p>
<p>E.g.::</p>
<div class="codehilite"><pre><span></span><span class="err">  stmt = text(&quot;SELECT * FROM table&quot;,</span>
<span class="err">                typemap={&#39;id&#39;: Integer, &#39;name&#39;: String},</span>
<span class="err">            )</span>
</pre></div>


<p>.. seealso::</p>
<div class="codehilite"><pre><span></span><span class="p">:</span><span class="n">ref</span><span class="p">:</span><span class="ss">`sqlexpression_text`</span> <span class="o">-</span> <span class="k">in</span> <span class="n">the</span> <span class="n">Core</span> <span class="n">tutorial</span>

<span class="p">:</span><span class="n">ref</span><span class="p">:</span><span class="ss">`orm_tutorial_literal_sql`</span> <span class="o">-</span> <span class="k">in</span> <span class="n">the</span> <span class="n">ORM</span> <span class="n">tutorial</span>
</pre></div></div>
  <div class="source_cont">
</div>

  </div>
  

    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="scenographer.sample.TableSample" class="name">class <span class="ident">TableSample</span></p>
      
  
    <div class="desc"><p>TableSample is a wrapper around the operations
to sample a single table</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-scenographer.sample.TableSample', this);">Show source &equiv;</a></p>
  <div id="source-scenographer.sample.TableSample" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">TableSample</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TableSample is a wrapper around the operations</span>
<span class="sd">    to sample a single table</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key_database</span> <span class="o">=</span> <span class="n">Database</span><span class="p">(</span><span class="s2">&quot;sqlite://&quot;</span><span class="p">)</span>

    <span class="n">table</span><span class="p">:</span> <span class="n">Table</span>
    <span class="n">conditions</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">sample_dag</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">source_database</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span>
        <span class="n">relations</span><span class="p">:</span> <span class="n">RelationDAG</span><span class="p">,</span>
        <span class="n">query_modifiers</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;TableSample&quot;</span><span class="p">]:</span>
        <span class="s2">&quot;Samples a database according to its relation graph&quot;</span>

        <span class="c1"># Change current working dir to our output directory</span>
        <span class="c1"># This way we avoid TableSample instances containing that information</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="c1"># Prepare the sqlite db</span>
        <span class="n">relations</span><span class="o">.</span><span class="n">key_schema</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
        <span class="n">relations</span><span class="o">.</span><span class="n">key_schema</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">relations</span><span class="o">.</span><span class="n">topologically_sorted</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="n">table</span><span class="p">,</span>
                <span class="n">conditions</span><span class="o">=</span><span class="n">freeze</span><span class="p">(</span><span class="n">query_modifiers</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s2">&quot;conditions&quot;</span><span class="p">]),</span>
                <span class="n">limit</span><span class="o">=</span><span class="n">query_modifiers</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s2">&quot;limit&quot;</span><span class="p">],</span>
            <span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">source_database</span><span class="p">)</span>

            <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">samples</span>

    <span class="c1"># @classmethod</span>
    <span class="c1"># @lru_cache()</span>
    <span class="c1"># def key_database(cls, relations) -&gt; Database:</span>
    <span class="c1">#     return Database(&quot;sqlite://&quot;)</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">key_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the table with the associated metadata</span>
<span class="sd">        tied to the key database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">tables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">source_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the table with the associated metadata</span>
<span class="sd">        tied to the source database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">key_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Column</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property defining the columns of the key database:</span>
<span class="sd">        the primary_keys and foreign_keys of each table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_table</span><span class="o">.</span><span class="n">columns</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">foreign_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Column</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the foreign keys of the table by listing</span>
<span class="sd">        the key columns and excluding any primary_key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">primary_key</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">is_entrypoint</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property defining if the table has foreign_keys.</span>
<span class="sd">        If it is false it means it has no dependencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Select</span><span class="p">:</span>
        <span class="s2">&quot;SQLAlchemy query object for the sampling query&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">condition</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_entrypoint</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">follow_conditions</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">follow_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Select</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Select</span><span class="p">:</span>
        <span class="s2">&quot;Append WHERE clauses to restrict the rows depending on the data already extracted&quot;</span>
        <span class="n">foreign_key</span><span class="p">:</span> <span class="n">Column</span>
        <span class="n">primary_key</span><span class="p">:</span> <span class="n">Column</span>

        <span class="c1"># For each foreign_key, build a where clause in the form of:</span>
        <span class="c1">#   WHERE sometable_id in (&lt;select id from sometable&gt;)</span>
        <span class="c1"># The subquery is executed on the key database and its results are</span>
        <span class="c1"># parametrized into the final query.</span>
        <span class="k">for</span> <span class="n">foreign_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>

            <span class="n">primary_key</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">)</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span><span class="o">.</span><span class="n">column</span>
            <span class="n">pk_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">execute_return_list</span><span class="p">(</span>
                <span class="n">select</span><span class="p">([</span><span class="n">primary_key</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">source_fk</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_table</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">foreign_key</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pk_data</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">source_fk</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">pk_data</span><span class="p">)</span> <span class="o">|</span> <span class="n">source_fk</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">source_fk</span><span class="o">.</span><span class="n">nullslast</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">source_fk</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">query</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s2">&quot;Raw SQL representation of the sampling query&quot;</span>
        <span class="n">complete_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">dialect</span><span class="o">=</span><span class="n">postgresql</span><span class="o">.</span><span class="n">dialect</span><span class="p">(),</span> <span class="n">compile_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;literal_binds&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

        <span class="c1"># Sampling requires we always extract all the columns, but</span>
        <span class="c1"># complete_query comes with the entire columns list.</span>
        <span class="c1"># So let&#39;s replace the column list with a wildcard:</span>
        <span class="n">query_str</span> <span class="o">=</span> <span class="s2">&quot;SELECT * &quot;</span> <span class="o">+</span> <span class="n">complete_query</span><span class="p">[</span><span class="n">complete_query</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;FROM&quot;</span><span class="p">)</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">query_str</span>

    <span class="nd">@property</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">persisted_records_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The path for the csv file for the data to be written in</span>
<span class="sd">        Relative to classmethod `sample_dag` directory argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">persist_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Insert retrieved keys from the table csv file into the sqlite key database.&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">persisted_records_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">persisted_record</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_columns</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">persisted_record</span> <span class="ow">in</span> <span class="n">DictReader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Got </span><span class="si">{}</span><span class="s2"> records for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span> <span class="n">keys</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">persist_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_database</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="s2">&quot;Insert retrieved rows into persisted_records_path&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Querying </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">persisted_records_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;a+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
            <span class="n">source_database</span><span class="o">.</span><span class="n">copy_to_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_database</span><span class="p">):</span>
        <span class="s2">&quot;Samples the table&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persist_records</span><span class="p">(</span><span class="n">source_database</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persist_keys</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#scenographer.sample.TableSample">TableSample</a></li>
          <li>builtins.tuple</li>
          <li>builtins.object</li>
          </ul>
          <h3>Class variables</h3>
            <div class="item">
            <p id="scenographer.sample.TableSample.conditions" class="name">var <span class="ident">conditions</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="scenographer.sample.TableSample.key_database" class="name">var <span class="ident">key_database</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="scenographer.sample.TableSample.limit" class="name">var <span class="ident">limit</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="scenographer.sample.TableSample.table" class="name">var <span class="ident">table</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="scenographer.sample.TableSample.follow_conditions">
    <p>def <span class="ident">follow_conditions</span>(</p><p>self, query)</p>
    </div>
    

    
  
    <div class="desc"><p>Append WHERE clauses to restrict the rows depending on the data already extracted</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-scenographer.sample.TableSample.follow_conditions', this);">Show source &equiv;</a></p>
  <div id="source-scenographer.sample.TableSample.follow_conditions" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">follow_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Select</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Select</span><span class="p">:</span>
    <span class="s2">&quot;Append WHERE clauses to restrict the rows depending on the data already extracted&quot;</span>
    <span class="n">foreign_key</span><span class="p">:</span> <span class="n">Column</span>
    <span class="n">primary_key</span><span class="p">:</span> <span class="n">Column</span>
    <span class="c1"># For each foreign_key, build a where clause in the form of:</span>
    <span class="c1">#   WHERE sometable_id in (&lt;select id from sometable&gt;)</span>
    <span class="c1"># The subquery is executed on the key database and its results are</span>
    <span class="c1"># parametrized into the final query.</span>
    <span class="k">for</span> <span class="n">foreign_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
        <span class="n">primary_key</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">)</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span><span class="o">.</span><span class="n">column</span>
        <span class="n">pk_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">execute_return_list</span><span class="p">(</span>
            <span class="n">select</span><span class="p">([</span><span class="n">primary_key</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">source_fk</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_table</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">foreign_key</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pk_data</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">source_fk</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">pk_data</span><span class="p">)</span> <span class="o">|</span> <span class="n">source_fk</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">source_fk</span><span class="o">.</span><span class="n">nullslast</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">source_fk</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">query</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="scenographer.sample.TableSample.persist_keys">
    <p>def <span class="ident">persist_keys</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Insert retrieved keys from the table csv file into the sqlite key database.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-scenographer.sample.TableSample.persist_keys', this);">Show source &equiv;</a></p>
  <div id="source-scenographer.sample.TableSample.persist_keys" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">persist_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="s2">&quot;Insert retrieved keys from the table csv file into the sqlite key database.&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">persisted_records_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">persisted_record</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_columns</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">persisted_record</span> <span class="ow">in</span> <span class="n">DictReader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Got </span><span class="si">{}</span><span class="s2"> records for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span> <span class="n">keys</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="scenographer.sample.TableSample.persist_records">
    <p>def <span class="ident">persist_records</span>(</p><p>self, source_database)</p>
    </div>
    

    
  
    <div class="desc"><p>Insert retrieved rows into persisted_records_path</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-scenographer.sample.TableSample.persist_records', this);">Show source &equiv;</a></p>
  <div id="source-scenographer.sample.TableSample.persist_records" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">persist_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_database</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="s2">&quot;Insert retrieved rows into persisted_records_path&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Querying </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">persisted_records_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;a+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
        <span class="n">source_database</span><span class="o">.</span><span class="n">copy_to_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="scenographer.sample.TableSample.sample">
    <p>def <span class="ident">sample</span>(</p><p>self, source_database)</p>
    </div>
    

    
  
    <div class="desc"><p>Samples the table</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-scenographer.sample.TableSample.sample', this);">Show source &equiv;</a></p>
  <div id="source-scenographer.sample.TableSample.sample" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_database</span><span class="p">):</span>
    <span class="s2">&quot;Samples the table&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">persist_records</span><span class="p">(</span><span class="n">source_database</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">persist_keys</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span>
</pre></div>

  </div>
</div>

  </div>
  
          <h3>Instance variables</h3>
            <div class="item">
            <p id="scenographer.sample.TableSample.foreign_keys" class="name">var <span class="ident">foreign_keys</span></p>
            

            
  
    <div class="desc"><p>Returns the foreign keys of the table by listing
the key columns and excluding any primary_key</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="scenographer.sample.TableSample.is_entrypoint" class="name">var <span class="ident">is_entrypoint</span></p>
            

            
  
    <div class="desc"><p>Property defining if the table has foreign_keys.
If it is false it means it has no dependencies.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="scenographer.sample.TableSample.key_columns" class="name">var <span class="ident">key_columns</span></p>
            

            
  
    <div class="desc"><p>Property defining the columns of the key database:
the primary_keys and foreign_keys of each table</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="scenographer.sample.TableSample.key_table" class="name">var <span class="ident">key_table</span></p>
            

            
  
    <div class="desc"><p>Returns the table with the associated metadata
tied to the key database</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="scenographer.sample.TableSample.persisted_records_path" class="name">var <span class="ident">persisted_records_path</span></p>
            

            
  
    <div class="desc"><p>The path for the csv file for the data to be written in
Relative to classmethod <code>sample_dag</code> directory argument.</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="scenographer.sample.TableSample.query" class="name">var <span class="ident">query</span></p>
            

            
  
    <div class="desc"><p>SQLAlchemy query object for the sampling query</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="scenographer.sample.TableSample.source_table" class="name">var <span class="ident">source_table</span></p>
            

            
  
    <div class="desc"><p>Returns the table with the associated metadata
tied to the source database</p></div>
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="scenographer.sample.TableSample.sql" class="name">var <span class="ident">sql</span></p>
            

            
  
    <div class="desc"><p>Raw SQL representation of the sampling query</p></div>
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="scenographer.sample.TableSample.sample_dag">
    <p>def <span class="ident">sample_dag</span>(</p><p>cls, source_database, relations, query_modifiers, directory)</p>
    </div>
    

    
  
    <div class="desc"><p>Samples a database according to its relation graph</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-scenographer.sample.TableSample.sample_dag', this);">Show source &equiv;</a></p>
  <div id="source-scenographer.sample.TableSample.sample_dag" class="source">
    <div class="codehilite"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">sample_dag</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">source_database</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span>
    <span class="n">relations</span><span class="p">:</span> <span class="n">RelationDAG</span><span class="p">,</span>
    <span class="n">query_modifiers</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;TableSample&quot;</span><span class="p">]:</span>
    <span class="s2">&quot;Samples a database according to its relation graph&quot;</span>
    <span class="c1"># Change current working dir to our output directory</span>
    <span class="c1"># This way we avoid TableSample instances containing that information</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="c1"># Prepare the sqlite db</span>
    <span class="n">relations</span><span class="o">.</span><span class="n">key_schema</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">relations</span><span class="o">.</span><span class="n">key_schema</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">key_database</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">relations</span><span class="o">.</span><span class="n">topologically_sorted</span><span class="p">:</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">table</span><span class="p">,</span>
            <span class="n">conditions</span><span class="o">=</span><span class="n">freeze</span><span class="p">(</span><span class="n">query_modifiers</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s2">&quot;conditions&quot;</span><span class="p">]),</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">query_modifiers</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="s2">&quot;limit&quot;</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">source_database</span><span class="p">)</span>
        <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">samples</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
